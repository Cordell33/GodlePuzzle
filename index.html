
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>G√∂dle</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #121212;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      margin: 0;
      min-height: 100vh;
      transition: background 0.3s ease, color 0.3s ease;
      color-scheme: dark;
    }
    body.light-mode {
      background: #f6f7f9;
      color: #1b1b1b;
      color-scheme: light;
    }
    h1 { 
      font-size: 2.8rem; 
      margin-bottom: 1rem; 
      color: #00bcd4;
      text-shadow: 0 0 10px rgba(0, 188, 212, 0.5);
    }
    .game-area {
      display: flex;
      align-items: flex-start;
      gap: 2rem;
      flex-wrap: wrap;
      justify-content: center;
      margin: 1rem 0;
    }
    .rules-card {
      width: 100%;
      max-width: 700px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 1.5rem 2rem;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
      margin: 0 0 1.5rem;
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }
    .rules-card h2 {
      margin-top: 0;
      margin-bottom: 0.75rem;
      font-size: 1.6rem;
      color: #00bcd4;
      text-shadow: 0 0 8px rgba(0, 188, 212, 0.4);
    }
    .rules-card p {
      margin-top: 0;
      margin-bottom: 0.75rem;
      color: #ddd;
      line-height: 1.5;
      transition: color 0.3s ease;
    }
    .rules-card ul {
      margin: 0;
      padding-left: 1.3rem;
      color: #ccc;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      font-size: 1.05rem;
      transition: color 0.3s ease;
    }
    .rules-card ul b {
      color: #fff;
    }
    .questions { 
      font-size: 1.2rem; 
      min-width: 280px; 
      display: flex; 
      flex-direction: column; 
      gap: 1rem; 
    }
    .question-container { 
      display: flex; 
      align-items: center; 
      gap: 0.5rem; 
    }
    .question-text {
      background-color: #333;
      border-left: 4px solid #00bcd4;
      padding: 0.8rem;
      font-weight: bold;
      border-radius: 4px;
      flex-grow: 1;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      transition: background-color 0.3s ease, box-shadow 0.3s ease, color 0.3s ease;
    }
    .question-result {
      font-size: 1.8rem;
      min-width: 40px;
      text-align: center;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    .hint-text {
      background-color: #333;
      border-left: 4px solid #ff9800;
      padding: 0.8rem;
      font-style: italic;
      border-radius: 4px;
      margin-top: 1rem;
      display: none;
      animation: fadeIn 0.5s ease-in;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .guesses { 
      display: flex; 
      flex-direction: column; 
      align-items: flex-start; 
      width: 100%; 
      max-width: 20rem; 
    }
    .row { 
      display: flex; 
      margin: 0.5rem 0; 
      justify-content: flex-start; 
      align-items: center; 
    }
    .cell { 
      width: 3rem; 
      height: 3rem; 
      font-size: 1.5rem; 
      margin: 0.2rem; 
      text-align: center; 
      border: 2px solid #444; 
      border-radius: 8px; 
      background: #222; 
      color: white;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    .cell:focus {
      outline: none;
      border-color: #00bcd4;
      box-shadow: 0 0 10px rgba(0, 188, 212, 0.5);
    }
    .cell.green { 
      background: #2ecc71; 
      border-color: #27ae60;
      transform: scale(1.05);
    }
    .cell.yellow { 
      background: #f39c12; 
      border-color: #d35400;
      transform: scale(1.05);
    }
    .cell.gray { 
      background: #7f8c8d; 
      border-color: #636e72;
    }
    /* Final code row gets a red border */
    .row.final-code .cell {
      border: 2px solid #27ae60;
      box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
    }

    #submit, #hint-button { 
      margin-top: 1.5rem; 
      padding: 0.8rem 1.5rem; 
      font-size: 1.1rem; 
      width: 100%; 
      max-width: 300px; 
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    #submit {
      background: #00bcd4;
      color: white;
    }
    #submit:hover {
      background: #0097a7;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    #hint-button {
      background: #ff9800;
      color: white;
    }
    .retry-message {
      margin: 0.4rem 0 0;
      font-size: 0.95rem;
      color: #ffcc80;
      text-align: center;
      display: none;
    }
    #hint-button:hover {
      background: #f57c00;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    #game-over {
      margin-top: 1.5rem;
      font-size: 1.5rem;
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      animation: fadeIn 0.5s ease-in;
      display: none; /* hidden until end */
      transition: background 0.3s ease, color 0.3s ease;
    }
    .difficulty.hidden { display: none; }
    .difficulty{
      width: min(520px, 92vw);
      margin-top: 18px;
      padding: 14px 14px 12px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
    }
    .difficulty-row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
    }
    .balls{
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .ball{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.10) inset;
    }
    .difficulty-value{
      font-weight: 700;
      font-size: 16px;
      white-space: nowrap;
    }
    .difficulty-controls{
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    #difficulty-slider{ width: 100%; }
    #difficulty-submit{
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      color: inherit;
      cursor: pointer;
    }
    #difficulty-submit:hover{
      background: rgba(255,255,255,0.16);
    }
    .difficulty-note{
      margin: 8px 0 0;
      opacity: 0.8;
      font-size: 13px;
    }
    :root{
      --diff1: #2f6bff;
      --diff2: #22c55e;
      --diff3: #facc15;
      --diff4: #fb923c;
      --diff5: #ef4444;
    }
    #menu-toggle {
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1100;
      background: #00bcd4;
      color: #121212;
      border: none;
      border-radius: 999px;
      padding: 0.55rem 1.1rem;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      transition: background 0.2s ease, transform 0.2s ease;
    }
    #menu-toggle:hover {
      background: #00a0b7;
      transform: translateY(-1px);
    }
    body.menu-open #menu-toggle {
      background: #0097a7;
      color: #fff;
    }
    #menu-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }
    body.menu-open #menu-backdrop {
      opacity: 1;
      pointer-events: auto;
    }
    #side-menu {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: min(320px, 85vw);
      background: #1b1b1b;
      box-shadow: 8px 0 24px rgba(0, 0, 0, 0.45);
      transform: translateX(-100%);
      transition: transform 0.3s ease, background 0.3s ease, box-shadow 0.3s ease, color 0.3s ease;
      z-index: 1050;
      padding: 1.5rem 1.75rem 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      overflow-y: auto;
    }
    body.menu-open #side-menu {
      transform: translateX(0);
    }
    #side-menu h2 {
      margin: 0;
      color: #00bcd4;
      font-size: 1.5rem;
      text-shadow: 0 0 8px rgba(0, 188, 212, 0.4);
    }
    #side-menu p {
      margin: 0;
      color: #ddd;
      line-height: 1.4;
      transition: color 0.3s ease;
    }
    .login-panel {
      margin-top: 1.5rem;
      background: rgba(255, 255, 255, 0.05);
      padding: 1rem 1.5rem;
      border-radius: 12px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }
    .login-panel button {
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      border: none;
      background: #00bcd4;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .login-panel > button + button {
      margin-top: 0.5rem;
    }
    .login-panel button:hover {
      background: #0097a7;
    }
    .login-panel .external-link {
      margin-top: 0.75rem;
      display: block;
      color: #00bcd4;
      font-weight: 600;
      text-decoration: none;
      transition: color 0.2s ease;
    }
    .login-panel .external-link:hover {
      color: #ff9800;
      text-decoration: underline;
    }
    #logout-button {
      margin-top: 0.75rem;
      width: 100%;
      background: #ef5350;
    }
    #logout-button:hover {
      background: #e53935;
    }
    .login-hint {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      color: #ccc;
      transition: color 0.3s ease;
    }
    #timer {
      margin-top: 1rem;
      font-size: 1.3rem;
      color: #00bcd4;
      font-weight: bold;
    }
    #stars { 
      margin-top: 1rem; 
      font-size: 1.8rem; 
      color: gold;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
    .share-buttons {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    .share-button {
      border: none;
      padding: 0.6rem 1.4rem;
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #1f1f1f;
      color: #fff;
      font-weight: 600;
      font-size: 1rem;
      letter-spacing: 0.02em;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, color 0.2s ease;
    }
    .share-button:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 12px 22px rgba(0, 0, 0, 0.25);
    }
    .share-button:focus-visible {
      outline: 3px solid rgba(255, 255, 255, 0.6);
      outline-offset: 2px;
    }
    .share-button.twitter { background: #1DA1F2; }
    .share-button.facebook { background: #0866FF; }
    .share-button.reddit { background: #FF4500; }
    .share-button.bluesky { background: #0A66FF; }
    .share-button.copy { background: #333; }
    #copy-message { 
      margin-top: 1rem; 
      color: #00bcd4; 
      display: none;
      animation: fadeIn 0.5s ease-in;
    }
    #share-results { 
      margin-top: 2rem; 
      display: none; 
      text-align: center;
      animation: fadeIn 0.5s ease-in;
    }
    footer {
      margin-top: 3rem;
      font-size: 0.9rem;
      color: #777;
      text-align: center;
      padding: 1.5rem;
      border-top: 1px solid #333;
      width: 100%;
      max-width: 600px;
      transition: color 0.3s ease, border-color 0.3s ease;
    }
    footer a {
      color: #00bcd4;
      text-decoration: none;
      transition: color 0.3s ease;
    }
    footer a:hover {
      color: #ff9800;
      text-decoration: underline;
    }

    .theme-toggle {
      margin-top: auto;
      padding-top: 1.25rem;
      border-top: 1px solid rgba(255, 255, 255, 0.12);
    }
    .toggle-control {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      font-weight: 600;
      color: #ddd;
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    .toggle-control input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
    .toggle-control .switch {
      width: 48px;
      height: 26px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.3);
      position: relative;
      transition: background 0.3s ease;
      flex-shrink: 0;
    }
    .toggle-control .switch::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
      transition: transform 0.3s ease;
    }
    .toggle-control input:checked + .switch {
      background: #00bcd4;
    }
    .toggle-control input:checked + .switch::after {
      transform: translateX(22px);
    }
    .toggle-control input:focus-visible + .switch {
      box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.45);
    }

    body.light-mode .rules-card {
      background: rgba(0, 0, 0, 0.05);
      box-shadow: 0 10px 24px rgba(31, 64, 79, 0.15);
    }
    body.light-mode .rules-card p {
      color: #2d2d2d;
    }
    body.light-mode .rules-card ul {
      color: #3b3b3b;
    }
    body.light-mode .rules-card ul b {
      color: #000;
    }
    body.light-mode .question-text {
      background-color: #eef3f7;
      color: #1b1b1b;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
    }
    body.light-mode .hint-text {
      background-color: #fff3e0;
      color: #5c3b00;
    }
    body.light-mode .cell {
      background: #ffffff;
      color: #111;
      border-color: #c3c8d0;
    }
    body.light-mode .cell.green {
      background: #66bb6a;
      border-color: #43a047;
      color: #0b2f16;
    }
    body.light-mode .cell.yellow {
      background: #ffd54f;
      border-color: #ffb300;
      color: #5a4100;
    }
    body.light-mode .cell.gray {
      background: #cfd8dc;
      border-color: #b0bec5;
    }
    body.light-mode .cell:focus {
      border-color: #00a0b7;
      box-shadow: 0 0 10px rgba(0, 160, 183, 0.4);
    }
    body.light-mode #side-menu {
      background: #fdfdfd;
      box-shadow: 8px 0 24px rgba(0, 0, 0, 0.1);
      color: #1f1f1f;
    }
    body.light-mode #side-menu p {
      color: #444;
    }
    body.light-mode .login-panel {
      background: rgba(0, 0, 0, 0.05);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
    }
    body.light-mode .login-hint {
      color: #555;
    }
    body.light-mode #game-over {
      background: rgba(0, 0, 0, 0.06);
      color: #1b1b1b;
    }
    body.light-mode .difficulty {
      background: rgba(0, 0, 0, 0.05);
      border-color: rgba(0, 0, 0, 0.12);
    }
    body.light-mode footer {
      color: #555;
      border-top: 1px solid #d4d4d4;
    }
    body.light-mode .share-button.copy {
      background: #f0f2f5;
      color: #1e1e1e;
    }
    body.light-mode .share-button.copy:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.18);
    }
    body.light-mode .theme-toggle {
      border-top: 1px solid rgba(0, 0, 0, 0.12);
    }
    body.light-mode .toggle-control {
      color: #2c2c2c;
    }
    body.light-mode .toggle-control .switch {
      background: rgba(0, 0, 0, 0.2);
    }
    body.light-mode .toggle-control input:checked + .switch {
      background: #0097a7;
    }
    body.light-mode .toggle-control .switch::after {
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    @media (max-width: 600px) {
      body { padding: 1rem; }
      .cell { width: 2.8rem; height: 2.8rem; font-size: 1.3rem; }
      .game-area { flex-direction: column; align-items: center; }
      .questions { min-width: 100%; }
      h1 { font-size: 2.2rem; }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background-color: #f39c12;
      opacity: 0.7;
      animation: confetti-fall 5s linear forwards;
      z-index: 1000;
    }
    
    @keyframes confetti-fall {
      0% {
        transform: translateY(-100px) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <button id="menu-toggle" type="button" aria-expanded="false" aria-controls="side-menu" aria-label="Open game menu">‚ò∞ Menu</button>
  <div id="menu-backdrop" role="presentation"></div>
  <aside id="side-menu" aria-hidden="true" tabindex="-1">
    <h2>Game Menu</h2>
    <p>Sign in to track your streak, then use the Start Game button below the board whenever you're ready to play.</p>
    <div class="login-panel" aria-live="polite">
      <button id="github-login-button" type="button">Continue with GitHub</button>
      <button id="google-login" type="button">Sign in with Google</button>
      <button id="logout-button" type="button" style="display: none;">Log Out</button>
      <p class="login-hint">Your daily streak syncs to your account across devices.</p>
      <a class="external-link" href="https://cordell33.github.io/GodleHex/" target="_blank" rel="noopener noreferrer">GodleHex (weekly)</a>
      <a class="external-link" href="https://cordell33.github.io/Cordlle/" target="_blank" rel="noopener noreferrer">Cordlle (monthly)</a>
    </div>
    <div class="theme-toggle">
      <label class="toggle-control" for="theme-toggle">
        <span>Light background</span>
        <input type="checkbox" id="theme-toggle" />
        <span class="switch" aria-hidden="true"></span>
      </label>
    </div>
  </aside>

  <div id="auth-bar" style="width:100%;max-width:680px;display:flex;justify-content:space-between;align-items:center;margin:0.5rem 0 0.25rem;">
    <div id="user-info">Guest</div>
    <div id="streak" title="Daily streak">üî• Guest play (streak not saved)</div>
  </div>

  <h1>G√∂dle</h1>

  <section class="rules-card" aria-labelledby="rules-heading">
    <h2 id="rules-heading">How to Play</h2>
    <p>Crack the daily code by solving quick logic and math prompts, then combine your answers to guess the final digits.</p>
    <ul>
      <li>Answer 4 questions using every digit (0-9) <b>exactly once</b>.</li>
      <li>Use your solutions as clues for the final 5-digit code.</li>
      <li><b>Green</b> = correct digit & position, <b>Yellow</b> = correct digit, wrong position.</li>
      <li>Beat the clock to earn bonus stars and share your results.</li>
      <li>Click <b>Start Game</b> below to begin, then <b>Submit Guess</b> for each row.</li>
    </ul>
  </section>

  <div id="timer">‚è± Time: 0:00</div>
  <div class="game-area">
    <div class="questions" id="questions"></div>
    <div class="guesses" id="guess-container"></div>
  </div>
  <button id="submit">Submit Guess</button>
  <p id="retry-message" class="retry-message" aria-live="polite"></p>
  <button id="hint-button" style="display: none;">Hint</button>
  <div id="hint" class="hint-text"></div>
  <div id="stars"></div>
  <div id="game-over" aria-live="polite"></div>
  <!-- Difficulty Meter (hidden until game ends) -->
  <section id="difficulty-meter" class="difficulty hidden" aria-label="Difficulty rating">
    <div class="difficulty-row">
      <div class="balls" aria-hidden="true">
        <span class="ball" data-ball="1"></span>
        <span class="ball" data-ball="2"></span>
        <span class="ball" data-ball="3"></span>
        <span class="ball" data-ball="4"></span>
        <span class="ball" data-ball="5"></span>
      </div>

      <div class="difficulty-value">
        <span id="difficulty-number">2.5</span><span class="out-of"> / 5</span>
      </div>
    </div>

    <div class="difficulty-controls">
      <input
        id="difficulty-slider"
        type="range"
        min="1"
        max="5"
        step="0.1"
        value="2.5"
        aria-label="Difficulty slider (1 to 5)"
      />
      <button id="difficulty-submit" type="button">Submit</button>
    </div>

    <p class="difficulty-note">Rate how hard that puzzle felt (decimals welcome).</p>
  </section>

  <div id="share-results">
    <h3>Share Your Results</h3>
    <div class="share-buttons">
      <button class="share-button twitter" type="button" onclick="shareTwitter()">
        Share on X (Twitter)
      </button>
      <button class="share-button facebook" type="button" onclick="shareFacebook()">
        Share on Facebook
      </button>
      <button class="share-button reddit" type="button" onclick="shareReddit()">
        Share on Reddit
      </button>
      <button class="share-button bluesky" type="button" onclick="shareBluesky()">
        Share on Bluesky
      </button>
      <button class="share-button copy" type="button" onclick="copyResults()">
        Copy Results
      </button>
    </div>
    <div id="copy-message" aria-live="polite">Copied to clipboard!</div>
  </div>

  <footer>created by Cordell Booth ‚Ä¢ <a href="https://patreon.com/GodleCreator" target="_blank">Donate</a> ‚Ä¢ <a href="https://www.facebook.com/groups/2109717096181882" target="_blank">Community</a></footer>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // TODO: paste your values from Supabase Project Settings ‚Üí API
    const SUPABASE_URL = "https://dvcoloirtfntndvnvkwz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2Y29sb2lydGZudG5kdm52a3d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2MzI4NTMsImV4cCI6MjA4NTIwODg1M30.zygt7fYxhSkFJ_1tPe9Crhzj0kFj89gj9x6OCWtafG0";

    // Make it available to your existing non-module script
    window.sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    });
  </script>
  <script>
    // ====== PUZZLE CONTENT ======

   const puzzleSchedule = [
    {
      releaseDate: "2026-02-01",
      questions: [
       "Slope of the line: y = 3x + 7 ?",
       "The y-intercept of the above line as a point (X,Y)?",
       "97 + 97 = ?",
       "573 √ó 5 = ?",
       "Enter the final 5-digit code"
      ],
      correctAnswers: [
       [3],
       [0, 7],
       [1, 9, 4],
       [2, 8, 6, 5],
       [2, 7, 6, 5, 9]
      ],
      difficultyRating: 2.6,
      hintText: "3, 07, 194, 2865.",
      code: [2, 7, 6, 5, 9]
    },
    {
      releaseDate: "2026-02-02",
      questions: [
       "The LCM of 2 and 3? (Least Common Multiple)? ",
       "Supplementary angle to 100¬∞ = ?",
       "1 dollar 2 dimes and a nickel in cents?",
       "10,000 - 6521 = ?",
       "Enter the final 5-digit code"
      ],
      correctAnswers: [
       [6],
       [8, 0],
       [1, 2, 5],
       [3, 4, 7, 9],
       [3, 0, 7, 2, 9]
      ],
      difficultyRating: 4.0,
      hintText: "6, 80, 125, 3479.",
      code: [3, 0, 7, 2, 9]
    },
    {
      releaseDate: "2026-02-03",
      questions: [
       "Sides on a parallelogram?",
       "Complementary angle to 20¬∞ = ?",
       "31 √ó 6 = ?",
       "1476 + 1477 = ?",
       "Enter the final 5-digit code"
      ],
      correctAnswers: [
       [4],
       [7, 0],
       [1, 8, 6],
       [2, 9, 5, 3],
       [2, 5, 6, 3, 9]
      ],
      difficultyRating: 3.1,
      hintText: "4, 70, 186, 2953.",
      code: [2, 5, 6, 3, 9]
    },
    {
      releaseDate: "2026-02-04",
      questions: [
       "What is x/x, where x is a nonzero number?",
       "43 √ó 2 = ?",
       "1000 ‚àí 695 = ?",
       "4407 + 1207 + 3633 = ?",
       "Enter the final 5-digit code"
      ],
      correctAnswers: [
       [1],
       [8, 6],
       [3, 0, 5],
       [9, 2, 4, 7],
       [9, 6, 4, 7, 1]
      ],
      difficultyRating: 1.8,
      hintText: "1, 86, 305, 9247.",
      code: [9, 6, 4, 7, 1]
    },
    {
      releaseDate: "2026-02-05",
      questions: [
       "Slope of the line through (0,0) and (2,4) = ?",
       "1502 - 1411 = ?",
       "Degrees in a quadrilateral = ?",
       "1829 √ó 3 = ?",
       "Enter the final 5-digit code"
      ],
      correctAnswers: [
       [2],
       [9, 1],
       [3, 6, 0],
       [5, 4, 8, 7],
       [5, 6, 8, 1, 7]
      ],
      difficultyRating: 3.7,
      hintText: "2, 91, 360, 5487.",
      code: [5, 6, 8, 1, 7]
    },
    {
      releaseDate: "2026-02-06",
      questions: [
       "Cats are said to have this many lives?",
       "Days in a fortnight (two weeks)?",
       "2c + a = b; a - c = 1; b = 7. Find (a,b,c)",
       "3029 √ó 2 = ?",
       "Enter the final 5-digit code"
      ],
      correctAnswers: [
       [9],
       [1, 4],
       [3, 7, 2],
       [6, 0, 5, 8],
       [6, 4, 7, 8, 5]
      ],
      difficultyRating: 2.5,
      hintText: "9, 14, 372, 6058.",
      code: [6, 4, 7, 8, 5]
    },
    {
      releaseDate: "2026-02-07",
      questions: [
       "How many tentacles does an octopus have?",
       "Compute 3 by 5 = ?",
       "Compute 31 √ó 12 = ?",
       "Compute 49 multiplied by 196 = ?",
       "Enter the final 5-digit code"
      ],
      correctAnswers: [
       [8],
       [1, 5],
       [3, 7, 2],
       [9, 6, 0, 4],
       [3, 6, 0, 7, 4]
      ],
      difficultyRating: 4.4,
      hintText: "8, 15, 372, 9604.",
      code: [3, 6, 0, 7, 4]
    },
    {
      releaseDate: "2026-02-08",
      questions: [
       "How many strings are on a standard guitar?",
       "Supplementary angle to 88¬∞ = ?",
       "Compute 25 √ó 6 = ?",
       "Compute 5000 ‚àí 163 = ?",
       "Enter the final 5-digit code"
      ],
      correctAnswers: [
       [6],
       [9, 2],
       [1, 5, 0],
       [4, 8, 3, 7],
       [4, 2, 0, 6, 7]
      ],
      difficultyRating: 3.3,
      hintText: "6, 92, 150, 4837.",
      code: [4, 2, 0, 6, 7]
    },
    {
      releaseDate: "2026-02-09",
      questions: [
       "How many players are on the field for one baseball team?",
       "Solve: x + 5 = 19.  x = ?",
       "Compute 31 √ó 20 = ?",
       "Compute 4000 ‚àí 242 = ?",
       "Enter the final 5-digit code"
      ],
      correctAnswers: [
       [9],
       [1, 4],
       [6, 2, 0],
       [3, 7, 5, 8],
       [7, 4, 0, 8, 1]
      ],
      difficultyRating: 3.9,
      hintText: "9, 14, 620, 3758.",
      code: [7, 4, 0, 8, 1]
    },
    {
      releaseDate: "2026-02-10",
      questions: [
       "How many Platonic solids exist?",
       "Compute 21 √ó 3 = ?",
       "Compute 70% of 400 = ?",
       "Compute 999 + 498 = ?",
       "Enter the final 5-digit code"
      ],
      correctAnswers: [
       [5],
       [6, 3],
       [2, 8, 0],
       [1, 4, 9, 7],
       [5, 3, 0, 7, 6]
      ],
      difficultyRating: 2.7,
      hintText: "5, 63, 280, 1497.",
      code: [5, 3, 0, 7, 6]
    },
    {
      releaseDate: "2026-02-11",
      questions: [
       "How many sides on a pentagon?",
       "Compute 7 √ó 3 √ó 3 = ?",
       "Compute 40% of 700 = ?",
       "Compute 1092 + 405 = ?",
       "Enter the final 5-digit code"
      ],
      correctAnswers: [
       [5],
       [6, 3],
       [2, 8, 0],
       [1, 4, 9, 7],
       [2, 3, 9, 7, 6]
      ],
      difficultyRating: 4.6,
      hintText: "5, 63, 280, 1497.",
      code: [2, 3, 9, 7, 6]
    },
    {
      releaseDate: "2026-02-12",
      questions: [
       "DNA uses this many nucleotide letters (A,C,G,T)?",
       "Complementary angle to 85¬∞ = ?",
       "Compute 6^3 = ?",
       "Compute 87 √ó 84 = ?",
       "Enter the final 5-digit code"
      ],
      correctAnswers: [
       [4],
       [9, 5],
       [2, 1, 6],
       [7, 3, 0, 8],
       [7, 5, 0, 4, 8]
      ],
      difficultyRating: 4.6,
      hintText: "4, 95, 216, 7308.",
      code: [7, 5, 0, 4, 8]
    },
    {
      releaseDate: "2026-02-13",
      questions: [
       "The sum of opposite sides of a die?",
       "Complementary angle to 72¬∞ = ?",
       "How many milliliters are in a quarter liter?",
       "Compute 3197 √ó 2 = ?",
       "Enter the final 5-digit code"
      ],
      correctAnswers: [
       [7],
       [1, 8],
       [2, 5, 0],
       [6, 3, 9, 4],
       [0, 3, 9, 4, 1]
      ],
      difficultyRating: 3.4,
      hintText: "7, 18, 250, 6394.",
      code: [0, 3, 9, 4, 1]
    },
    {
      releaseDate: "2026-02-14",
      questions: [
       "How many ounces are in 1 cup?",
       "How many hours are in a day?",
       "Compute 65 √ó 11 = ?",
       "Compute 19,170 √∑ 3 = ?",
       "Enter the final 5-digit code"
      ],
      correctAnswers: [
       [8],
       [2, 4],
       [7, 1, 5],
       [6, 3, 9, 0],
       [6, 4, 9, 8, 0]
      ],
      difficultyRating: 2.2,
      hintText: "8, 24, 715, 6390.",
      code: [6, 4, 9, 8, 0]
    }
   ].sort((a, b) => a.releaseDate.localeCompare(b.releaseDate));

   const pyramid = [1, 2, 3, 4, 5];
   let questions = [];
   let correctAnswers = [];
   let hintText = "";
   let code = [];
   let difficultyRating = 2.5;
   let activePuzzleReleaseDate = null;
   let nextScheduledReleaseDate = null;
   let releaseTimerId = null;

   function applyPuzzleData(puzzle) {
     questions = puzzle.questions;
     correctAnswers = puzzle.correctAnswers;
     hintText = puzzle.hintText;
     code = [...puzzle.code];
     difficultyRating = typeof puzzle.difficultyRating === "number" ? puzzle.difficultyRating : 2.5;
   }

   function getEasternDateParts(date = new Date()) {
     const formatter = new Intl.DateTimeFormat("en-US", {
       timeZone: "America/New_York",
       year: "numeric",
       month: "2-digit",
       day: "2-digit",
       hour: "2-digit",
       minute: "2-digit",
       second: "2-digit",
       hour12: false
     });
     const parts = formatter.formatToParts(date);
     const result = {};
     parts.forEach(({ type, value }) => {
       if (type !== "literal") {
         result[type] = value;
       }
     });
     return result;
   }

   function getEasternDateString(date = new Date()) {
     const { year, month, day } = getEasternDateParts(date);
     return `${year}-${month}-${day}`;
   }

   function getEasternOffsetMinutes(date) {
     const formatter = new Intl.DateTimeFormat("en-US", {
       timeZone: "America/New_York",
       hour: "2-digit",
       minute: "2-digit",
       hour12: false,
       timeZoneName: "shortOffset"
     });
     const parts = formatter.formatToParts(date);
     const tzName = parts.find((part) => part.type === "timeZoneName")?.value || "GMT-4";
     const match = tzName.match(/GMT([+-])(\d{1,2})(?::(\d{2}))?/);
     if (!match) {
       return -4 * 60;
     }
     const sign = match[1] === "-" ? -1 : 1;
     const hours = Number(match[2]);
     const minutes = match[3] ? Number(match[3]) : 0;
     return sign * (hours * 60 + minutes);
   }

   function getEasternMidnightUtcTimestamp(dateString) {
     const [year, month, day] = dateString.split("-").map(Number);
     const referenceDate = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));
     const offsetMinutes = getEasternOffsetMinutes(referenceDate);
     return Date.UTC(year, month - 1, day, 0, 0, 0) - offsetMinutes * 60 * 1000;
   }

   function getActivePuzzle(date = new Date()) {
     const currentEasternDate = getEasternDateString(date);
     let selectedPuzzle = puzzleSchedule[0];
     for (const puzzle of puzzleSchedule) {
       if (puzzle.releaseDate <= currentEasternDate) {
         selectedPuzzle = puzzle;
       } else {
         break;
       }
     }
     const upcomingPuzzle = puzzleSchedule.find((puzzle) => puzzle.releaseDate > currentEasternDate);
     return {
       puzzle: selectedPuzzle,
       nextReleaseDate: upcomingPuzzle ? upcomingPuzzle.releaseDate : null
     };
   }

   const MAX_TIMEOUT_MS = 2147483647;

   function scheduleNextReleaseCheck(nextReleaseDate) {
     if (releaseTimerId) {
       clearTimeout(releaseTimerId);
       releaseTimerId = null;
     }
     if (!nextReleaseDate) {
       return;
     }
     const targetUtc = getEasternMidnightUtcTimestamp(nextReleaseDate);
     const delay = targetUtc - Date.now();
     const safeDelay = delay > 0 ? Math.min(delay, MAX_TIMEOUT_MS) : 0;
     releaseTimerId = setTimeout(() => {
       releaseTimerId = null;
       handlePuzzleRelease();
     }, safeDelay);
   }

   function handlePuzzleRelease() {
     const { puzzle, nextReleaseDate } = getActivePuzzle();
     if (puzzle.releaseDate !== activePuzzleReleaseDate) {
       applyPuzzleData(puzzle);
       activePuzzleReleaseDate = puzzle.releaseDate;
       const wasActive = gameActive;
       initGame();
       if (wasActive) {
         gameActive = false;
         submitBtn.textContent = "Start Game";
       }
     }
     nextScheduledReleaseDate = nextReleaseDate;
     scheduleNextReleaseCheck(nextScheduledReleaseDate);
   }

   const { puzzle: initialPuzzle, nextReleaseDate: initialNextReleaseDate } = getActivePuzzle();
   applyPuzzleData(initialPuzzle);
   activePuzzleReleaseDate = initialPuzzle.releaseDate;
   nextScheduledReleaseDate = initialNextReleaseDate;


    // ====== GAME STATE & DOM ======
    let currentStep = 0;
    const questionsDiv = document.getElementById("questions");
    const guessContainer = document.getElementById("guess-container");
    const submitBtn = document.getElementById("submit"); // FIX: define before use
    const hintBtn = document.getElementById("hint-button");
    const gameOverDiv = document.getElementById("game-over");
    const starsDiv = document.getElementById("stars");
    const menuToggle = document.getElementById("menu-toggle");
    const menuBackdrop = document.getElementById("menu-backdrop");
    const sideMenu = document.getElementById("side-menu");
    const timerDiv = document.getElementById("timer");
    const hintDiv = document.getElementById("hint");
    const shareResults = document.getElementById("share-results");
    const streakEl = document.getElementById("streak");
    const userInfo = document.getElementById("user-info");
    const githubLoginButton = document.getElementById("github-login-button");
    const googleLoginButton = document.getElementById("google-login");
    const logoutButton = document.getElementById("logout-button");
    const themeToggle = document.getElementById("theme-toggle");
    const difficultyMeter = document.getElementById("difficulty-meter");
    const difficultySlider = document.getElementById("difficulty-slider");
    const difficultyNumber = document.getElementById("difficulty-number");
    const difficultySubmit = document.getElementById("difficulty-submit");
    const difficultyBalls = Array.from(difficultyMeter.querySelectorAll(".ball"));
    const retryMessage = document.getElementById("retry-message");

    let startTime;
    let timerInterval;
    let questionElements = [];
    let stars = 0;
    let correctCount = 0;
    let totalTime = 0;
    let isCorrect = false;
    let gameActive = false;
    const defaultUser = "Guest";
    let currentUser = defaultUser;
    let currentSession = null;

    async function waitForSupabaseClient({ timeoutMs = 10000 } = {}) {
      const start = Date.now();
      while (Date.now() - start < timeoutMs) {
        if (window.sb) return window.sb;
        await new Promise(r => setTimeout(r, 25));
      }
      console.warn("Supabase client (window.sb) not ready within timeout.");
      return null;
    }

    submitBtn.textContent = "Start Game";
    scheduleNextReleaseCheck(nextScheduledReleaseDate);

    function setMenuOpen(open) {
      document.body.classList.toggle("menu-open", open);
      menuToggle.setAttribute("aria-expanded", open ? "true" : "false");
      menuToggle.setAttribute("aria-label", open ? "Close game menu" : "Open game menu");
      menuToggle.textContent = open ? "‚úï Close" : "‚ò∞ Menu";
      sideMenu.setAttribute("aria-hidden", open ? "false" : "true");
    }
    function toggleMenu() {
      const isOpen = document.body.classList.contains("menu-open");
      setMenuOpen(!isOpen);
      if (isOpen) {
        menuToggle.focus();
      } else {
        sideMenu.focus();
      }
    }
    function closeMenu() {
      if (document.body.classList.contains("menu-open")) {
        setMenuOpen(false);
        menuToggle.focus();
      }
    }

    menuToggle.addEventListener("click", toggleMenu);
    menuBackdrop.addEventListener("click", closeMenu);
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeMenu();
      }
    });

    const themeStorageKey = "godle_theme";
    function applyThemePreference(mode) {
      const useLight = mode === "light";
      document.body.classList.toggle("light-mode", useLight);
      if (themeToggle) {
        themeToggle.checked = useLight;
      }
    }

    const storedThemePreference = localStorage.getItem(themeStorageKey);
    const colorSchemeQuery = window.matchMedia ? window.matchMedia('(prefers-color-scheme: light)') : null;
    const prefersLight = !!colorSchemeQuery && colorSchemeQuery.matches;
    const initialTheme = storedThemePreference === "light" || storedThemePreference === "dark"
      ? storedThemePreference
      : (prefersLight ? "light" : "dark");
    applyThemePreference(initialTheme);

    if (!storedThemePreference && colorSchemeQuery) {
      const handleSchemeChange = (event) => {
        applyThemePreference(event.matches ? "light" : "dark");
      };
      if (typeof colorSchemeQuery.addEventListener === "function") {
        colorSchemeQuery.addEventListener("change", handleSchemeChange);
      } else if (typeof colorSchemeQuery.addListener === "function") {
        colorSchemeQuery.addListener(handleSchemeChange);
      }
    }

    if (themeToggle) {
      themeToggle.addEventListener("change", () => {
        const nextTheme = themeToggle.checked ? "light" : "dark";
        applyThemePreference(nextTheme);
        localStorage.setItem(themeStorageKey, nextTheme);
      });
    }

    setMenuOpen(false);

    // ===== DAILY STREAK (Supabase completions) =====
    async function getAuthedUser() {
      const sb = await waitForSupabaseClient();
      if (!sb?.auth) return null;
      try {
        const { data, error } = await sb.auth.getSession();
        if (error) return null;
        currentSession = data?.session || null;
        return data?.session?.user || null;
      } catch (error) {
        console.warn("Supabase getSession failed:", error);
        return null;
      }
    }

    function parseDateString(dateString) {
      const [year, month, day] = dateString.split("-").map(Number);
      return new Date(Date.UTC(year, month - 1, day));
    }

    function formatDateString(date) {
      const year = date.getUTCFullYear();
      const month = String(date.getUTCMonth() + 1).padStart(2, "0");
      const day = String(date.getUTCDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function shiftDateString(dateString, deltaDays) {
      const date = parseDateString(dateString);
      date.setUTCDate(date.getUTCDate() + deltaDays);
      return formatDateString(date);
    }

    async function fetchUserCompletions() {
      const sb = await waitForSupabaseClient();
      const user = await getAuthedUser();
      if (!sb || !user) return [];
      const { data, error } = await sb
        .from("puzzle_completions")
        .select("puzzle_date")
        .eq("user_id", user.id)
        .order("puzzle_date", { ascending: false })
        .limit(60);
      if (error) {
        console.warn("Supabase completion read failed:", error);
        return [];
      }
      return (data || [])
        .map((row) => row.puzzle_date)
        .filter(Boolean);
    }

    function computeStreakFromDates(dates, todayEastern) {
      if (!Array.isArray(dates) || dates.length === 0) {
        return { current: 0, best: 0, completedToday: false };
      }
      const uniqueDates = Array.from(new Set(dates));
      const dateSet = new Set(uniqueDates);
      const yesterdayEastern = shiftDateString(todayEastern, -1);
      let anchor = null;
      let completedToday = false;
      if (dateSet.has(todayEastern)) {
        anchor = todayEastern;
        completedToday = true;
      } else if (dateSet.has(yesterdayEastern)) {
        anchor = yesterdayEastern;
      }
      let current = 0;
      if (anchor) {
        let cursor = anchor;
        while (dateSet.has(cursor)) {
          current += 1;
          cursor = shiftDateString(cursor, -1);
        }
      }
      const sorted = uniqueDates
        .map((dateString) => ({ dateString, time: parseDateString(dateString).getTime() }))
        .sort((a, b) => a.time - b.time);
      let best = 0;
      let run = 0;
      for (let i = 0; i < sorted.length; i += 1) {
        if (i === 0) {
          run = 1;
        } else {
          const prev = sorted[i - 1].dateString;
          const expected = shiftDateString(prev, 1);
          run = sorted[i].dateString === expected ? run + 1 : 1;
        }
        best = Math.max(best, run);
      }
      return { current, best, completedToday };
    }

    async function insertCompletionOnWin(starsEarned, timeSeconds) {
      const sb = await waitForSupabaseClient();
      const user = await getAuthedUser();
      if (!sb || !user) return { inserted: false, alreadyCompleted: false };
      const puzzleDate = getPuzzleDate();
      const payload = {
        user_id: user.id,
        puzzle_date: puzzleDate
      };
      const { error } = await sb
        .from("puzzle_completions")
        .upsert(payload, { onConflict: "user_id,puzzle_date", ignoreDuplicates: true });
      if (error) {
        if (error.code === "23505") {
          return { inserted: false, alreadyCompleted: true };
        }
        console.warn("Supabase completion upsert failed:", error);
        return { inserted: false, alreadyCompleted: false };
      }
      return { inserted: true, alreadyCompleted: false };
    }

    async function syncStreakDisplay() {
      if (!currentSession?.user) {
        streakEl.textContent = "üî• Guest play (streak not saved)";
        return;
      }
      const todayEastern = getEasternDateString();
      const completions = await fetchUserCompletions();
      const streak = computeStreakFromDates(completions, todayEastern);
      const t = streak.current === 1 ? "day" : "days";
      const suffix = streak.completedToday
        ? `(best ${streak.best})`
        : "(solve today to keep it)";
      streakEl.textContent = `üî• ${streak.current}-${t} streak ${suffix}`;
    }
    function getSessionUsername(sessionUser) {
      if (!sessionUser) return "";
      return sessionUser.email || sessionUser.user_metadata?.email || sessionUser.id || "";
    }
    function applyAuthState(session = null) {
      currentSession = session;
      const sessionUser = session?.user;
      if (sessionUser) {
        const username = getSessionUsername(sessionUser);
        currentUser = username || sessionUser.id;
        userInfo.textContent = `üë§ ${username || sessionUser.id}`;
        logoutButton.style.display = "block";
        if (githubLoginButton) githubLoginButton.style.display = "none";
        if (googleLoginButton) googleLoginButton.style.display = "none";
      } else {
        currentUser = defaultUser;
        userInfo.textContent = defaultUser;
        logoutButton.style.display = "none";
        if (githubLoginButton) githubLoginButton.style.display = "inline-flex";
        if (googleLoginButton) googleLoginButton.style.display = "inline-flex";
      }
      syncStreakDisplay();
    }
    applyAuthState();

    (async () => {
      const sb = await waitForSupabaseClient();
      if (!sb?.auth) return;
      try {
        const { data } = await sb.auth.getSession();
        await applyAuthState(data.session);
      } catch (error) {
        console.warn("Supabase session restore failed:", error);
      }
      sb.auth.onAuthStateChange(async (_event, session) => {
        await applyAuthState(session);
      });
    })();

    if (githubLoginButton) {
      githubLoginButton.addEventListener("click", async () => {
        await window.sb.auth.signInWithOAuth({
          provider: "github",
          options: {
            redirectTo: "https://cordell33.github.io/GodlePuzzle/"
          }
        });
      });
    }
    if (googleLoginButton) {
      googleLoginButton.addEventListener("click", async () => {
        await window.sb.auth.signInWithOAuth({
          provider: "google",
          options: { redirectTo: "https://cordell33.github.io/GodlePuzzle/" }
        });
      });
    }

    logoutButton.addEventListener("click", async () => {
      applyAuthState();
      if (window.sb?.auth?.signOut) {
        try {
          await window.sb.auth.signOut();
        } catch (error) {
          console.warn("Supabase sign out failed:", error);
        }
      }
    });

    // ===== INIT =====
    function initGame() {
      questionsDiv.innerHTML = '';
      guessContainer.innerHTML = '';
      gameOverDiv.innerHTML = '';
      gameOverDiv.style.display = 'none';
      starsDiv.innerHTML = '';
      retryMessage.textContent = '';
      retryMessage.style.display = 'none';
      difficultyMeter.classList.add("hidden");
      shareResults.style.display = 'none';
      currentStep = 0;
      stars = 0;
      correctCount = 0;
      totalTime = 0;
      isCorrect = false;
      submitBtn.disabled = false;
      hintBtn.disabled = false;
      hintBtn.style.display = 'none';
      hintDiv.style.display = 'none';
      hintDiv.textContent = '';
      questionElements = [];
      timerDiv.textContent = '‚è± Time: 0:00';
    }

    function updateTimer() {
      const now = new Date();
      const elapsed = Math.floor((now - startTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      timerDiv.textContent = `‚è± Time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function getElapsedSeconds() { 
      return Math.floor((new Date() - startTime) / 1000); 
    }

    function renderQuestion() {
      const questionContainer = document.createElement("div");
      questionContainer.className = "question-container";

      const questionText = document.createElement("div");
      questionText.className = "question-text";
      questionText.textContent = questions[currentStep];
      questionContainer.appendChild(questionText);

      const resultSpan = document.createElement("div");
      resultSpan.className = "question-result";
      resultSpan.id = `result-${currentStep}`;
      questionContainer.appendChild(resultSpan);

      questionsDiv.appendChild(questionContainer);
      questionElements.push(questionContainer);

      const rowDiv = document.createElement("div");
      rowDiv.className = "row";
      for (let i = 0; i < pyramid[currentStep]; i++) {
        const input = document.createElement("input");
        // Add special class for final code row
        if (currentStep === pyramid.length - 1) {
  rowDiv.classList.add("final-code");
          }
        input.className = "cell active";
        input.maxLength = 1;
        input.type = "text";
        input.inputMode = "numeric";
        input.setAttribute('inputmode','numeric');
        input.setAttribute('pattern','\\d');
        input.addEventListener("input", (e) => {
          e.target.value = e.target.value.replace(/\D/g, '').slice(0,1);
          if (e.target.value.length === 1 && i < pyramid[currentStep] - 1) {
            rowDiv.children[i + 1].focus();
          }
        });
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") submitBtn.click();
          if ((e.key === "Backspace" || e.key === "Delete") && e.target.value === "" && i > 0) {
            rowDiv.children[i - 1].focus();
            return;
          }
          if (e.key === "ArrowLeft") {
            e.preventDefault();
            if (i > 0) {
              rowDiv.children[i - 1].focus();
            }
            return;
          }
          if (e.key === "ArrowRight") {
            e.preventDefault();
            if (i < rowDiv.children.length - 1) {
              rowDiv.children[i + 1].focus();
            }
          }
        });
        rowDiv.appendChild(input);
      }
      
      guessContainer.appendChild(rowDiv);
      if (rowDiv.firstChild) rowDiv.firstChild.focus();

      // Show hint button only on final question
      hintBtn.style.display = currentStep === pyramid.length - 1 ? "block" : "none";
      hintDiv.style.display = "none";
    }

    function getInputValues() {
      const activeInputs = document.querySelectorAll(".cell.active");
      return Array.from(activeInputs).map(input => input.value.trim());
    }

    // Wordle-style duplicate handling
    function colorFeedback(guess, codeArr) {
      const res = Array(guess.length).fill('gray');
      const counts = {};
      codeArr.forEach((d) => { counts[d] = (counts[d] || 0) + 1; });
      // pass 1: greens
      guess.forEach((d,i) => {
        if (codeArr[i] === d) { res[i] = 'green'; counts[d]--; }
      });
      // pass 2: yellows
      guess.forEach((d,i) => {
        if (res[i] === 'gray' && counts[d] > 0) { res[i] = 'yellow'; counts[d]--; }
      });
      return res;
    }

    function evaluate(inputArr) {
      const inputDigits = inputArr.map(val => isNaN(val) ? val : Number(val));
      isCorrect = inputDigits.every((val, i) =>
        val === correctAnswers[currentStep][i] ||
        (typeof val === 'string' && val.toUpperCase() === String(correctAnswers[currentStep][i]).toUpperCase())
      );

      const resultSpan = document.getElementById(`result-${currentStep}`);
      resultSpan.textContent = isCorrect ? "‚úÖ" : "‚ùå";
      if (isCorrect && currentStep < 4) { correctCount++; }

      const feedback = colorFeedback(inputDigits, code);
      const activeInputs = document.querySelectorAll(".cell.active");
      activeInputs.forEach((input, i) => { 
        input.classList.remove("active"); 
        input.classList.add(feedback[i]); 
        input.disabled = true; 
      });
    }

    function showShareButtons() { shareResults.style.display = "block"; }

    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

    function getPuzzleDate() {
      return activePuzzleReleaseDate || getEasternDateString();
    }

    async function getDifficultyAverage(defaultRating) {
      const sb = window.sb;
      const keyDate = activePuzzleReleaseDate || getEasternDateString();

      if (!sb) return defaultRating;

      const { data, error } = await sb
        .from("difficulty_ratings")
        .select("rating")
        .eq("puzzle_date", keyDate);

      if (error) {
        console.warn("Supabase avg read failed:", error);
        return defaultRating;
      }
      if (!data || data.length === 0) return defaultRating;

      const total = data.reduce((sum, row) => sum + Number(row.rating || 0), 0);
      return total / data.length;
    }

    async function getUserDifficultyRating() {
      const sb = window.sb;
      const userId = currentSession?.user?.id;
      if (!userId) return null;

      if (!sb) return null;

      const keyDate = activePuzzleReleaseDate || getEasternDateString();
      const { data, error } = await sb
        .from("difficulty_ratings")
        .select("rating")
        .eq("puzzle_date", keyDate)
        .eq("user_id", userId)
        .maybeSingle();

      if (error) {
        console.warn("Supabase user rating read failed:", error);
        return null;
      }
      if (!data) return null;
      const rating = Number(data.rating);
      return Number.isFinite(rating) ? rating : null;
    }

    async function hasRatedToday(userId, puzzleDate) {
      const sb = await waitForSupabaseClient();
      if (!sb || !userId) return false;
      const { data, error } = await sb
        .from("difficulty_ratings")
        .select("rating")
        .eq("puzzle_date", puzzleDate)
        .eq("user_id", userId)
        .maybeSingle();
      if (error) {
        console.warn("Supabase rating check failed:", error);
        return false;
      }
      return !!data;
    }

    async function storeDifficultyRating(rating) {
      const sb = window.sb;
      const keyDate = activePuzzleReleaseDate || getEasternDateString();

      if (!sb) return false;

      const userId = currentSession?.user?.id;
      if (!userId) {
        console.warn("Supabase session missing user id; rating not stored.");
        return;
      }

      const payload = {
        user_id: userId,
        puzzle_date: keyDate,
        rating: Number(rating),
      };

      const alreadyRated = await hasRatedToday(userId, keyDate);
      if (alreadyRated) {
        return false;
      }

      const { error } = await sb
        .from("difficulty_ratings")
        .upsert(payload, { onConflict: "user_id,puzzle_date" });

      if (error) {
        if (error.code === "23505") {
          return false;
        }
        console.warn("Supabase rating insert failed:", error);
        return false;
      }
      return true;
    }

    function getBallColor(i) {
      switch (i) {
        case 1: return getComputedStyle(document.documentElement).getPropertyValue("--diff1").trim();
        case 2: return getComputedStyle(document.documentElement).getPropertyValue("--diff2").trim();
        case 3: return getComputedStyle(document.documentElement).getPropertyValue("--diff3").trim();
        case 4: return getComputedStyle(document.documentElement).getPropertyValue("--diff4").trim();
        case 5: return getComputedStyle(document.documentElement).getPropertyValue("--diff5").trim();
        default: return "#999";
      }
    }

    function renderDifficulty(rating) {
      const clamped = clamp(rating, 1, 5);
      difficultyNumber.textContent = clamped.toFixed(1);
      difficultyBalls.forEach((ball, idx) => {
        const i = idx + 1;
        const fill = clamp(clamped - (i - 1), 0, 1);
        ball.style.background = getBallColor(i);
        const minOpacity = 0.18;
        const opacity = minOpacity + (1 - minOpacity) * fill;
        ball.style.opacity = String(opacity);
      });
    }

    async function showDifficultyMeter({ defaultRating = 2.5 } = {}) {
      const user = await getAuthedUser();
      const hasAccount = !!user;
      const puzzleDate = getPuzzleDate();

      // Start with default while we fetch
      difficultySlider.value = String(clamp(defaultRating, 1, 5));
      renderDifficulty(parseFloat(difficultySlider.value));
      difficultyMeter.classList.remove("hidden");

      const alreadyRated = hasAccount ? await hasRatedToday(user.id, puzzleDate) : false;
      const submittedRating = alreadyRated ? await getUserDifficultyRating() : null;

      // Fetch global average from Supabase
      const averageRating = await getDifficultyAverage(defaultRating);
      const targetRating = typeof submittedRating === "number" ? submittedRating : averageRating;
      difficultySlider.value = String(clamp(targetRating, 1, 5));
      renderDifficulty(parseFloat(difficultySlider.value));

      if (!hasAccount) {
        difficultySlider.disabled = true;
        difficultySubmit.textContent = "Log in to rate";
        difficultySubmit.disabled = true;
        return;
      }

      if (alreadyRated) {
        difficultySlider.disabled = true;
        difficultySubmit.textContent = "Already rated";
        difficultySubmit.disabled = true;
        return;
      }

      if (!isCorrect) {
        difficultySlider.disabled = true;
        difficultySubmit.textContent = "Solve to submit";
        difficultySubmit.disabled = true;
        return;
      }

      difficultySlider.disabled = false;
      difficultySubmit.textContent = "Submit";
      difficultySubmit.disabled = false;
    }

    function shareTwitter() {
      window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(buildShareText())}`, '_blank', 'noopener');
    }
    function shareFacebook() {
      const shareText = buildShareText();
      const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(shareText)}`;
      const win = window.open(shareUrl, '_blank', 'noopener,width=626,height=436');
      if (!win) {
        copyResults();
        alert('Facebook share popup was blocked. Your results were copied‚Äîpaste them into Facebook manually.');
      }
    }

    function shareReddit() {
      const titleSuffix = activePuzzleReleaseDate ? ` - ${activePuzzleReleaseDate}` : '';
      const shareUrl = `https://www.reddit.com/r/godle/submit?selftext=true&title=${encodeURIComponent(`G√∂dle Results${titleSuffix}`)}&text=${encodeURIComponent(buildShareText())}`;
      const win = window.open(shareUrl, '_blank', 'noopener,width=960,height=700');
      if (!win) { copyResults(); alert('Reddit share popup was blocked. Your results were copied‚Äîshare them in r/godle manually.'); }
    }

    function shareBluesky() {
      const shareUrl = `https://bsky.app/intent/compose?text=${encodeURIComponent(buildShareText())}`;
      const win = window.open(shareUrl, '_blank', 'noopener');
      if (!win) { copyResults(); alert('Bluesky share popup was blocked. Your results were copied‚Äîpost them on Bluesky manually.'); }
    }

    function buildShareText() {
      const minutes = Math.floor(totalTime / 60);
      const seconds = totalTime % 60;
      let grid = "";
      const inputs = document.querySelectorAll(".cell");
      let index = 0;
      for (let r = 0; r < pyramid.length - 1; r++) {
        let row = "";
        for (let c = 0; c < pyramid[r]; c++) {
          const cell = inputs[index++];
          if (cell && cell.classList.contains("green")) row += "üü©";
          else if (cell && cell.classList.contains("yellow")) row += "üü®";
          else row += "‚¨õ";
        }
        grid += (r > 0 ? "\n" : "") + row;
      }
      return `G√∂dle - I solved it in ${minutes}:${seconds.toString().padStart(2,'0')} with ${stars} stars! ‚≠ê\n${grid}\n\nTry it yourself: ${window.location.href}`;
    }

    async function copyResults() {
      const text = buildShareText();
      try {
        await navigator.clipboard.writeText(text);
        document.getElementById("copy-message").style.display = "block";
        setTimeout(() => { document.getElementById("copy-message").style.display = "none"; }, 2000);
      } catch (err) {
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        document.getElementById("copy-message").style.display = "block";
        setTimeout(() => { document.getElementById("copy-message").style.display = "none"; }, 2000);
      }
    }

    // === Hint button ===
    hintBtn.addEventListener("click", () => {
      hintDiv.textContent = hintText;
      hintDiv.style.display = "block";
      hintBtn.disabled = true;
      hintDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });

    // === Submit flow ===
    submitBtn.addEventListener("click", async () => {
      if (!gameActive) {
        startGame();
        return;
      }
      const values = getInputValues();
      const expectedLen = pyramid[currentStep];
      if (values.length !== expectedLen || values.some(v => v === "")) {
        alert("Please complete this guess.");
        return;
      }

      evaluate(values);
      currentStep++;

      if (currentStep < pyramid.length) {
        renderQuestion();
      } else {
        clearInterval(timerInterval);
        const guess = values.map(val => isNaN(val) ? val : Number(val));
        isCorrect = guess.every((d, i) => d === code[i]);
        totalTime = getElapsedSeconds();
        const minutes = Math.floor(totalTime / 60);
        const seconds = totalTime % 60;
        gameOverDiv.style.display = 'block';
        gameOverDiv.innerHTML = isCorrect
          ? `üéâ You cracked the code in ${minutes}:${seconds.toString().padStart(2, '0')}`
          : `‚ùå Incorrect. The code was ${code.join("")}`;

        submitBtn.disabled = true;
        retryMessage.textContent = '';
        retryMessage.style.display = 'none';

        if (isCorrect) {
          if (totalTime <= 60) stars++;
          stars += correctCount;
          starsDiv.textContent = `‚≠ê Stars: ${stars}`;
          await insertCompletionOnWin(stars, totalTime);
          await syncStreakDisplay();
          showShareButtons();
        } else {
          stars = 0;
        }

        await showDifficultyMeter({ defaultRating: difficultyRating });
        gameActive = false;
        if (!isCorrect) {
          const loggedIn = !!currentSession?.user;
          if (loggedIn) {
            submitBtn.textContent = "Retry Puzzle";
            retryMessage.textContent = "Incorrect. Tap Retry Puzzle to try again.";
            retryMessage.style.display = "block";
          } else {
            submitBtn.textContent = "Start Game";
          }
        } else {
          submitBtn.textContent = "Start Game";
        }
        submitBtn.disabled = false;
      }
    });

    function startGame() {
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      initGame();
      setMenuOpen(false);
      startTime = new Date();
      timerInterval = setInterval(updateTimer, 1000);
      gameActive = true;
      submitBtn.textContent = "Submit Guess";
      renderQuestion();
    }

    // Optional: keep focused cell visible on mobile when keyboard opens
    document.addEventListener('focusin', (e) => {
      if (e.target.classList?.contains('cell')) {
        e.target.scrollIntoView({ block: 'center', behavior: 'smooth' });
      }
    });

    difficultySlider.addEventListener("input", () => {
      renderDifficulty(parseFloat(difficultySlider.value));
    });

    difficultySubmit.addEventListener("click", async () => {
      if (!isCorrect) return;

      const rating = parseFloat(difficultySlider.value);
      const hasAccount = !!currentSession?.user;
      if (!hasAccount) {
        setMenuOpen(true);
        githubLoginButton.focus();
        return;
      }
      const stored = await storeDifficultyRating(rating);
      if (!stored) {
        difficultySubmit.textContent = "Already rated";
        difficultySubmit.disabled = true;
        difficultySlider.disabled = true;
        return;
      }
      try {
        await window.onSubmitDifficulty?.(rating);
      } catch (e) {
        console.warn("Difficulty submit failed:", e);
      }
      difficultySubmit.textContent = "Submitted ‚úì";
      difficultySubmit.disabled = true;
      difficultySlider.disabled = true;
    });

    renderDifficulty(parseFloat(difficultySlider.value));
  </script>
</body>
</html>
